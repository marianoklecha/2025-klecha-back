<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <changeSet id="0011-01-family" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="family"/>
            </not>
        </preConditions>
         <createTable tableName="family">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="holder_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="surname" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="birthdate" type="date"/>
            <column name="gender" type="text"/>
            <column name="dni" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="relationship" type="text">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="family" baseColumnNames="holder_id"
                                constraintName="fk_family_holder"
                                referencedTableName="users" referencedColumnNames="id"
                                onDelete="CASCADE"/>

        <createIndex indexName="idx_family_holder_id" tableName="family">
            <column name="holder_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="0011-02-add-family-to-turns" author="MediBook_Admin">
        <addColumn tableName="turns_assigned">
            <column name="family_member_id" type="uuid">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint baseTableName="turns_assigned" baseColumnNames="family_member_id"
                                constraintName="fk_turns_assigned_family"
                                referencedTableName="family" referencedColumnNames="id"
                                onDelete="RESTRICT"/>

        <createIndex indexName="idx_turns_assigned_family_member_id" tableName="turns_assigned">
            <column name="family_member_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="0011-03-global-dni-check" author="MediBook_Admin">
        <sql dbms="postgresql" splitStatements="false">
            CREATE OR REPLACE FUNCTION check_dni_uniqueness() RETURNS trigger AS $$
            BEGIN
                IF (TG_TABLE_NAME = 'family') THEN
                    IF EXISTS (SELECT 1 FROM users WHERE dni = NEW.dni) THEN
                        RAISE EXCEPTION 'El DNI % ya existe registrado como usuario titular', NEW.dni;
                    END IF;
                ELSIF (TG_TABLE_NAME = 'users') THEN
                    IF EXISTS (SELECT 1 FROM family WHERE dni = NEW.dni) THEN
                        RAISE EXCEPTION 'El DNI % ya existe registrado como familiar', NEW.dni;
                    END IF;
                END IF;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;

            CREATE TRIGGER trg_check_dni_family_insert_update
            BEFORE INSERT OR UPDATE ON family
            FOR EACH ROW EXECUTE FUNCTION check_dni_uniqueness();

            CREATE TRIGGER trg_check_dni_users_insert_update
            BEFORE INSERT OR UPDATE ON users
            FOR EACH ROW EXECUTE FUNCTION check_dni_uniqueness();
        </sql>
    </changeSet>

</databaseChangeLog>